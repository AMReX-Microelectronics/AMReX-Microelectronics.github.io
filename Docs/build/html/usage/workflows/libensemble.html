<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run LibEnsemble on WarpX &mdash; MicroEleX 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MicroEleX
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">INSTALLATION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/artemis.html">ARTEMIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/eleqtroneX.html">ELEQTRONeX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/ferrox.html">FerroX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/magnex.html">MagneX</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">USAGE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../run_artemis.html">Run ARTEMIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run_eleqtronex.html">Run ELEQTRONeX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run_ferrox.html">Run FerroX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../run_magnex.html">Run MagneX</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DATA ANALYSIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dataanalysis/formats.html">Output Formats and Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataanalysis/yt.html">yt-project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">EPILOGUE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements.html">Funding and Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MicroEleX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Run LibEnsemble on WarpX</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/usage/workflows/libensemble.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="run-libensemble-on-warpx">
<span id="libensemble"></span><h1>Run LibEnsemble on WarpX<a class="headerlink" href="#run-libensemble-on-warpx" title="Link to this heading"></a></h1>
<p><a class="reference external" href="https://github.com/Libensemble">LibEnsemble</a> is a library to coordinate the concurrent evaluation of dynamic ensembles of calculations.
While a WarpX simulation can provide insight in some physics, it remains a single point evaluation in the space of parameters.
If you have a simulation ready for use, but would like to (i) scan over some input parameters uniformly for, e.g., a tolerance study, or (ii) have a random evaluation of the space of input parameters within a given span or (iii) tune some input parameters to optimize an output parameter, e.g., beam emittance, energy spread, etc., LibEnsemble provides these capabilities and will take care of tasks monitoring with fault tolerance on multiple platforms (LibEnsemble targets modern HPC platforms like Summit).</p>
<p>Scripts to run LibEnsemble on WarpX simulations can be found in <code class="docutils literal notranslate"><span class="pre">WarpX/Tools/LibEnsemble/</span></code>.
This documentation does not aim at giving a training on LibEnsemble, so please refer to the <a class="reference external" href="https://libensemble.readthedocs.io/en/develop/">LibEnsemble documentation</a> for technical details.</p>
<section id="warpx-example-problem-for-libensemble-study">
<h2>WarpX example problem for LibEnsemble study<a class="headerlink" href="#warpx-example-problem-for-libensemble-study" title="Link to this heading"></a></h2>
<p>The WarpX example is built on a 2D input file (so that 1 simulation take &lt; 1 min) of a 2-stage laser-wakefield simulation in a boosted frame.
It aims at optimizing emittance preservation in the coupling between two consecutive plasma accelerator stages.
Each stage accelerates an externally-injected electron beam, which charge has been tuned to show a decent amount of Ez field flattening due to longitudinal beam loading.
Each stage has a parabolic transverse profile to guide the laser pulse, and a uniform longitudinal profile with cos-shape ramps and the entrance and at the exit.
A fresh laser pulse is introduced at the entrance of each stage and deleted at the exit.
The beam transverse distribution is matched to the first stage and the beam is injected at the beginning of the plateau of the first stage, so that the emittance is conserved in the first stage.
The two stages are separated by a few-cm gap, and a focusing lens is placed in-between.
Note that this is a very low resolution simulation to show an example, so it is <strong>not</strong> close to numerical convergence.</p>
<p>In this example, we allow LibEnsemble to tune four <strong>input parameters</strong>:</p>
<blockquote>
<div><ul class="simple">
<li><p>Length of the downramp of the first stage</p></li>
<li><p>Longitudinal position of the focusing lens (between the two stages)</p></li>
<li><p>Strength of the focusing lens</p></li>
<li><p>Length of the downramp of the second stage</p></li>
</ul>
</div></blockquote>
<p>The <strong>output parameter</strong> that LibEnsemble minimizes is the beam emittance at the exit of the second stage, while making sure the charge loss is small.</p>
<p>The scripts provided can run on a local machine or on the Summit supercomputer at OLCF.
Two options are available: random sampling of parameter space or optimization on the output parameter.
For the latter, we are using the Asynchronously Parallel Optimization Solver for finding Multiple Minima <a class="reference external" href="https://libensemble.readthedocs.io/en/develop/examples/aposmm.html">APOSMM</a> method provided by LibEnsemble.</p>
</section>
<section id="install-libensemble">
<h2>Install LibEnsemble<a class="headerlink" href="#install-libensemble" title="Link to this heading"></a></h2>
<p>Besides a working WarpX executable, you have to install libEnsemble and its dependencies.</p>
<p>You can either install all packages via <cite>conda</cite> (recommended),</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>libensemble<span class="w"> </span>matplotlib<span class="w"> </span>numpy<span class="w"> </span>scipy<span class="w"> </span>yt
</pre></div>
</div>
<p>or try to install the same dependencies via <cite>pip</cite> (pick one <em>or</em> the other; note our <a class="reference internal" href="../../install/hpc/summit.html#building-summit"><span class="std std-ref">installation details on Summit</span></a>):</p>
</section>
<section id="what-s-in-tools-libensemble">
<h2>What’s in <code class="docutils literal notranslate"><span class="pre">Tools/LibEnsemble</span></code>?<a class="headerlink" href="#what-s-in-tools-libensemble" title="Link to this heading"></a></h2>
<p>See the <a class="reference external" href="https://libensemble.readthedocs.io/en/develop/overview_usecases.html">LibEnsemble User Guide</a> for an overview of LibEnsemble concepts.
In a nutshell, a user needs to define</p>
<blockquote>
<div><ul class="simple">
<li><p>A generator function <code class="docutils literal notranslate"><span class="pre">gen_f</span></code> that will generate inputs for the simulation, which can be done uniformly, randomly or using an optimizer.
The generator output, i.e., the simulation input, is called <code class="docutils literal notranslate"><span class="pre">'x'</span></code>.
The generator is provided  by LibEnsemble.
When the generator is an optimizer, it takes the simulation output called <code class="docutils literal notranslate"><span class="pre">'f'</span></code> as an input.</p></li>
<li><p>A simulation function <code class="docutils literal notranslate"><span class="pre">sim_f</span></code> that will take <code class="docutils literal notranslate"><span class="pre">'x'</span></code> as an input and return a single output value <code class="docutils literal notranslate"><span class="pre">'f'</span></code>.
In our example, <code class="docutils literal notranslate"><span class="pre">sim_f</span></code> modifies the WarpX input file depending on <code class="docutils literal notranslate"><span class="pre">'x'</span></code>, launches a WarpX simulation and reads the simulation output plotfile to extract <code class="docutils literal notranslate"><span class="pre">'f'</span></code>.</p></li>
<li><p>An allocator function <code class="docutils literal notranslate"><span class="pre">alloc_f</span></code> that will feed available workers with tasks.
This is provided by LibEnsemble.</p></li>
</ul>
</div></blockquote>
<p>The files in <code class="docutils literal notranslate"><span class="pre">Tools/LibEnsemble/</span></code> are:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">run_libensemble_on_warpx.py</span></code></dt><dd><p>This is the main LibEnsemble script.
It imports <code class="docutils literal notranslate"><span class="pre">gen_f</span></code> and <code class="docutils literal notranslate"><span class="pre">alloc_f</span></code> from LibEnsemble, <code class="docutils literal notranslate"><span class="pre">sim_f</span></code> from file <code class="docutils literal notranslate"><span class="pre">warpx_simf.py</span></code> (see below), defines dictionaries for parameters of each of these objects (<code class="docutils literal notranslate"><span class="pre">gen_specs</span></code> includes lower and upper bound of each element in the input array <code class="docutils literal notranslate"><span class="pre">'x'</span></code>, <code class="docutils literal notranslate"><span class="pre">alloc_specs</span></code> and <code class="docutils literal notranslate"><span class="pre">sim_specs</span></code> respectively) and runs LibEnsemble.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">warpx_simf.py</span></code></dt><dd><p>defines the <code class="docutils literal notranslate"><span class="pre">sim_f</span></code> function called <code class="docutils literal notranslate"><span class="pre">run_warpx</span></code>:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find function “run_warpx” in doxygen xml output for project “MicroEleX” from directory: ../doxyxml/</p>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sim/inputs</span></code></dt><dd><p>WarpX input file. Some of its parameters are modified in <code class="docutils literal notranslate"><span class="pre">run_warpx</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">write_sim_input.py</span></code></dt><dd><p>(util) update one WarpX input file depending on values in <code class="docutils literal notranslate"><span class="pre">'x'</span></code> for this run.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find function “write_sim_input” in doxygen xml output for project “MicroEleX” from directory: ../doxyxml/</p>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">read_sim_output.py</span></code></dt><dd><p>(util) Read WarpX plotfile and return <code class="docutils literal notranslate"><span class="pre">'f'</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find function “read_sim_output” in doxygen xml output for project “MicroEleX” from directory: ../doxyxml/</p>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">plot_results.py</span></code></dt><dd><p>(util) Read LibEnsemble output files <code class="docutils literal notranslate"><span class="pre">.npy</span></code> and <code class="docutils literal notranslate"><span class="pre">.pickle</span></code> and plot output <code class="docutils literal notranslate"><span class="pre">'f'</span></code> (and other output, just for convenience) as a function of input from all simulations.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">all_machine_specs.py</span></code></dt><dd><p>(util) dictionaries of machine-specific parameters.
For convenience, the maximum number of WarpX runs is defined there.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">summit_submit_mproc.sh</span></code></dt><dd><p>Submission script for LibEnsemble+WarpX on Summit.
Make sure to edit this file and add your project ID for allocations.</p>
</dd>
</dl>
</section>
<section id="run-the-example">
<h2>Run the example<a class="headerlink" href="#run-the-example" title="Link to this heading"></a></h2>
<p>On Summit or for a local run, LibEnsemble can run with a Random Number Generator (easiest, good as a first try) or with an optimizer (requires python package <code class="docutils literal notranslate"><span class="pre">nlopt</span></code>).
This is set by the variable <code class="docutils literal notranslate"><span class="pre">generator_type</span></code> in <code class="docutils literal notranslate"><span class="pre">run_libensemble_on_warpx.py</span></code>.
We hereafter assume that all Python modules required are installed and that a WarpX executable is available.</p>
<section id="run-locally">
<h3>Run locally<a class="headerlink" href="#run-locally" title="Link to this heading"></a></h3>
<p>Adjust the <code class="docutils literal notranslate"><span class="pre">local_specs</span></code> dictionary in <code class="docutils literal notranslate"><span class="pre">all_machine_specs.py</span></code> to fix the path to the WarpX executable (and optionally change the number of cores and OpenMP threads), and run</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>run_libensemble_on_warpx.py<span class="w"> </span>--comms<span class="w"> </span><span class="nb">local</span><span class="w"> </span>--nworkers<span class="w"> </span><span class="m">3</span>
</pre></div>
</div>
<p>This is adapted to a 4-core machine, as it will use:</p>
<ul class="simple">
<li><p>1 process to run LibEnsemble</p></li>
<li><p>1 process (among the 3 workers) to run the generator</p></li>
<li><p>2 processes to run 2 concurrent simulations</p></li>
</ul>
</section>
<section id="run-on-summit-at-olcf">
<h3>Run on Summit at OLCF<a class="headerlink" href="#run-on-summit-at-olcf" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-r</span> <span class="pre">$HOME/warpx/Tools/LibEnsemble/*</span> <span class="pre">sim_directory</span></code></p></li>
<li><p>modify <code class="docutils literal notranslate"><span class="pre">run_libensemble_on_warpx.py</span></code> to have <code class="docutils literal notranslate"><span class="pre">machine</span> <span class="pre">=</span> <span class="pre">'summit'</span></code></p></li>
<li><p>modify <code class="docutils literal notranslate"><span class="pre">all_machine_specs.py</span></code> to put the right path to the WarpX executable</p></li>
<li><p>modify <code class="docutils literal notranslate"><span class="pre">summit_submit_mproc.sh</span></code> to set <code class="docutils literal notranslate"><span class="pre">LIBE_PLOTS</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> and set the project ID</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bsub</span> <span class="pre">summit_submit_mproc.sh</span></code>:</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bsub<span class="w"> </span>summit_submit_mproc.sh
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, MicroEleX collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>